{% extends "network/layout.html" %}
{% load static %}
<!-- https://ichef.bbci.co.uk/news/660/cpsprodpb/48DD/production/_107435681_perro1.jpg -->
<!-- https://cdn.pixabay.com/photo/2015/12/15/09/04/banner-1093909__340.jpg -->
{% block body %}
  {% if user.is_authenticated %}
    <div class="contenedor-encabezado">
      <div class="contenedor-foto">
        <!-- <img class="imagen-foto" src="https://ichef.bbci.co.uk/news/660/cpsprodpb/48DD/production/_107435681_perro1.jpg" alt="profile-picture"> -->
      </div>
      <div class="contenedor-banner">
        <img class="imagen-banner" src="https://cdn.pixabay.com/photo/2015/12/15/09/04/banner-1093909__340.jpg" alt="banner-de-burbujas">  
      </div>
    </div>
    <div class="contenedor-cuerpo">
      <div class="contenedor-datos-usuario">
        @{{ user.username }} <br>
        Joined {{ month }} {{ year }} <br>
        <div class="contenedor-follow">
          <span><strong>{{ following }}</strong> Following</span> 
          <span><strong id="followers">{{ followers }}</strong> Followers</span>
        </div>
      </div>
      <input type="hidden" value="{{ user.id }}" id="user-id">
      <div class="contenedor-boton">
        <!-- {% if user.id == login_user.id %}
          <button type="button" class="btn btn-outline-primary">Edit</button>
        {% else %} -->
          <button type="button" id="follow-unfollow" class="btn btn-outline-primary">{{ option }}</button>
        <!-- {% endif %} -->
      </div>
    </div>
    <div class="contenedor-lista-posts">
      <div class="contenedor-lista-posts">
        {% for post in posts %}
        <div class="contenedor-post-anterior">
          <div class="contenedor-usuario-post">
            <a id="prueba" href="{% url 'profile' post.user.id %}">{{ post.user.username }}</a>
          </div>
          <div class="contenedor-text-post">
            {{ post.text }} <br>
            {{ post.date_creation }} <br>
            <input type="hidden" class="post_id_list" value="{{ post.id }}">
          </div>
          <div class="contenedor-likes">
            {% if post.id in posts_con_like %}
            <span class="like-button">‚ù§</span>
            {% else %}
            <span class="like-button">ü§ç</span>
            {% endif%}
            <span class="like-count">{{ post.post_likes.count }}</span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}


{% endblock %}
{% block script %}
<script>
  document.addEventListener('DOMContentLoaded', function () {

    button = document.querySelector("button")
    button.addEventListener('click', () => button_action('action'));
    number_of_followers = document.querySelector('#followers')
    like_list = document.querySelectorAll('.like-button');
    for (let i = 0; i < like_list.length; i++) {
      like_list[i].addEventListener('click', () => toggle_like(i));
    }
  });

  function button_action(action) {
    if (button.innerHTML == 'Follow'){
      console.log('Follow')
      user_id = (document.querySelector('#user-id').value)
      fetch('network', {
        method: 'POST',
        body: JSON.stringify({
          following_user_id: user_id,
          action: 'Follow'
        })
      })
      .then(response => response.json())
      .then(result => {
        console.log(result)
        number_of_followers.innerHTML = result.number_of_followers
        button.innerHTML = 'Unfollow'
      });
      console.log(number_of_followers)
      // location.reload()
    }
    else if (button.innerHTML == 'Unfollow'){
      console.log('Unfollow')
      user_id = (document.querySelector('#user-id').value)
      fetch('network', {
        method: 'POST',
        body: JSON.stringify({
          following_user_id: user_id,
          action: 'Unfollow'
        })
      })
      .then(response => response.json())
      .then(result => {
        console.log(result)
        number_of_followers.innerHTML = result.number_of_followers
        button.innerHTML = 'Follow'
      });

      // location.reload()
    }

    else if (button.innerHTML == 'Edit'){
      console.log('Edit')
    }
    // location.reload()
  
  }

  function toggle_like(i) {
    id_list = document.querySelectorAll('.post_id_list')
    post_id = id_list[i].value
    hearts = document.querySelectorAll('.like-button');
    like_count = document.querySelectorAll('.like-count')

    
    fetch(`/network/like/${post_id}`)
      .then(response => response.json())
      .then(object => {
        if (object['text'] === 'Like') {
          hearts[i].innerHTML = '‚ù§'
          like_count[i].innerHTML = object['like_count']
        }
        else {
          hearts[i].innerHTML = 'ü§ç'
          like_count[i].innerHTML = object['like_count']
        }
      });
  }
</script>
{% endblock %}